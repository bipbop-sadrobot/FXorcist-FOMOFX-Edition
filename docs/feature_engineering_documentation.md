# Feature Engineering Documentation

## Number Analysis as a Feature Engineering Tool

The `number_analysis_improved.py` script can be used to analyze a list of numbers and identify patterns. It can be used to score numbers based on the rarity of patterns. The script takes a CSV, JSON, or TXT file as input and saves the results to `analysis_results.csv`.

The features generated by this script (e.g., number score, identified patterns) could be incorporated into the feature engineering pipeline to improve model performance.

This document describes the features engineered in the `forex_ai_dashboard/pipeline/feature_engineering.py` module.

## 1. Lag Features

-   **Description:** Adds lagged values of specified columns.
-   **Function:** `add_lags`
-   **Parameters:**
    -   `columns`: List of columns to add lags to (default: `['close']`).
    -   `lags`: List of lag periods (default: `[1, 2, 3, 5, 10, 20, 50]`).
    -   `add_decay`: Whether to add exponentially weighted moving average decay (default: `True`).
    -   `decay_span`: Span for the exponential decay (default: `10`).
-   **Generated Features:**
    -   `{col}_lag_{L}`: Lagged value of column `col` by `L` periods.
    -   `{col}_lag_decay_{decay_span}`: Exponentially weighted moving average of column `col` with span `decay_span`.

## 2. Rolling Statistics Features

-   **Description:** Calculates rolling statistics for a given column.
-   **Function:** `add_rolling_stats`
-   **Parameters:**
    -   `column`: Column to calculate rolling statistics for (default: `'close'`).
    -   `windows`: List of window sizes (default: `[5, 10, 20, 50, 100]`).
    -   `add_zscore`: Whether to add z-score (default: `True`).
    -   `add_skew_kurt`: Whether to add skewness and kurtosis (default: `True`).
-   **Generated Features:**
    -   `{column}_sma_{w}`: Simple moving average with window `w`.
    -   `{column}_ema_{w}`: Exponential moving average with span `w`.
    -   `{column}_std_{w}`: Standard deviation with window `w`.
    -   `{column}_min_{w}`: Minimum value with window `w`.
    -   `{column}_max_{w}`: Maximum value with window `w`.
    -   `{column}_z_{w}`: Z-score with window `w`.
    -   `{column}_skew_{w}`: Skewness with window `w`.
    -   `{column}_kurt_{w}`: Kurtosis with window `w`.

## 3. Momentum & Oscillators

-   **Description:** Implements various momentum and oscillator indicators.
-   **Functions:** `add_rsi`, `add_stochastic`, `add_williams_r`, `add_roc`, `add_macd`, `add_adx`
-   **Parameters:**
    -   `add_rsi`:
        -   `column`: Column to calculate RSI for (default: `'close'`).
        -   `period`: RSI period (default: `14`).
    -   `add_stochastic`:
        -   `period`: Stochastic oscillator period (default: `14`).
        -   `column`: Column to calculate stochastic oscillator for (default: `'close'`).
    -   `add_williams_r`:
        -   `period`: Williams %R period (default: `14`).
        -   `column`: Column to calculate Williams %R for (default: `'close'`).
    -   `add_roc`:
        -   `column`: Column to calculate ROC for (default: `'close'`).
        -   `period`: ROC period (default: `12`).
    -   `add_macd`:
        -   `column`: Column to calculate MACD for (default: `'close'`).
        -   `short`: Short EMA period (default: `12`).
        -   `long`: Long EMA period (default: `26`).
        -   `signal`: Signal line EMA period (default: `9`).
    -   `add_adx`:
        -   `period`: ADX period (default: `14`).
-   **Generated Features:**
    -   `{column}_rsi`: Relative Strength Index.
    -   `{column}_stoch_k`: Stochastic oscillator %K.
    -   `{column}_stoch_d`: Stochastic oscillator %D.
    -   `{column}_williams_r`: Williams %R.
    -   `{column}_roc_{period}`: Rate of Change.
    -   `{column}_macd`: MACD line.
    -   `{column}_macd_signal`: MACD signal line.
    -   `{column}_macd_histogram`: MACD histogram.
    -   `pdi`: Positive Directional Indicator.
    -   `mdi`: Negative Directional Indicator.
    -   `adx`: Average Directional Index.

## 4. Volatility Bands & Channels

-   **Description:** Adds volatility bands and channels.
-   **Functions:** `add_bollinger`, `add_atr`, `add_keltner`, `add_donchian`
-   **Parameters:**
    -   `add_bollinger`:
        -   `column`: Column to calculate Bollinger Bands for (default: `'close'`).
        -   `window`: Bollinger Bands window (default: `20`).
        -   `num_std`: Number of standard deviations for the bands (default: `2.0`).
    -   `add_atr`:
        -   `period`: ATR period (default: `14`).
    -   `add_keltner`:
        -   `ema_len`: Keltner Channels EMA length (default: `20`).
        -   `atr_mult`: ATR multiplier (default: `2.0`).
    -   `add_donchian`:
        -   `window`: Donchian Channel window (default: `20`).
-   **Generated Features:**
    -   `{column}_bb_mid_{window}`: Bollinger Bands middle band.
    -   `{column}_bb_upper_{window}`: Bollinger Bands upper band.
    -   `{column}_bb_lower_{window}`: Bollinger Bands lower band.
    -   `{column}_bb_width_{window}`: Bollinger Bands width.
    -   `{column}_bb_percent_b_{window}`: Bollinger Bands %B.
    -   `atr`: Average True Range.
    -   `kc_mid_{ema_len}`: Keltner Channels middle band.
    -   `kc_upper_{ema_len}`: Keltner Channels upper band.
    -   `kc_lower_{ema_len}`: Keltner Channels lower band.
    -   `donchian_high_{window}`: Donchian Channel upper band.
    -   `donchian_low_{window}`: Donchian Channel lower band.

## 5. Derived Transforms

-   **Description:** Calculates derived transformations of the price data.
-   **Functions:** `add_basic_transforms`, `add_fourier_terms`, `add_hilbert_features`
-   **Parameters:**
    -   `add_basic_transforms`: None
    -   `add_fourier_terms`:
        -   `periods`: List of periods for Fourier terms (default: `None`, infers daily/weekly).
        -   `K`: Number of Fourier terms (default: `3`).
    -   `add_hilbert_features`:
        -   `column`: Column to apply Hilbert transform to (default: `'close'`).
-   **Generated Features:**
    -   `log_return`: Logarithmic return.
    -   `ret`: Simple return.
    -   `ret_abs`: Absolute return.
    -   `range_hl`: High-low range.
    -   `range_oc`: Open-close range.
    -   `ema_12`: 12-period EMA.
    -   `ema_26`: 26-period EMA.
    -   `dpo_20`: Detrended Price Oscillator (20-period).
    -   `f_sin_{P}_{k}`: Sine Fourier term with period `P` and term `k`.
    -   `f_cos_{P}_{k}`: Cosine Fourier term with period `P` and term `k`.
    -   `{column}_hilbert_amp`: Hilbert transform amplitude envelope.
    -   `{column}_hilbert_freq`: Hilbert transform instantaneous frequency.

## 6. Forecast Residuals & Convolution Patterns

-   **Description:** Adds forecast residuals and convolution patterns.
-   **Functions:** `add_forecast_residuals`, `add_convolution_patterns`
-   **Parameters:**
    -   `add_forecast residuals`:
        -   `column`: Column to calculate forecast residuals for (default: `'close'`).
        -   `window`: Rolling window size (default: `20`).
    -   `add_convolution_patterns`:
        -   `column`: Column to apply convolution to (default: `'close'`).
        -   `kernel`: Convolution kernel (default: `[-1, 0, 1]`).
-   **Generated Features:**
    -   `forecast_residual`: Forecast residual.
    -   `{column}_conv_edge`: Convolution edge.

## 7. Session & External Features

-   **Description:** Adds session-based features and merges external data.
-   **Functions:** `add_session_features`, `merge_external_series`
-   **Parameters:**
    -   `add_session_features`: None
    -   `merge_external_series`:
        -   `externals`: Dictionary of external pandas Series.
        -   `how`: Join method (default: `'left'`).
-   **Generated Features:**
    -   `hour_sin`: Sine of the hour.
    -   `hour_cos`: Cosine of the hour.
    -   `dow_sin`: Sine of the day of the week.
    -   `dow_cos`: Cosine of the day of the week.
    -   `session_tokyo`: Tokyo session indicator.
    -   `session_london`: London session indicator.
    -   `session_newyork`: New York session indicator.
    -   `{external_series_name}`: Values from the external series.

## 8. Wavelet Denoising

-   **Description:** Applies wavelet denoising to a time series.
-   **Function:** `add_wavelet_denoise`
-   **Parameters:**
    -   `column`: Column to denoise (default: `'close'`).
    -   `wavelet`: Wavelet type (default: `'db2'`).
    -   `level`: Denoising level (default: `1`).
-   **Generated Features:**
    -   `{column}_denoised_wv`: Wavelet-denoised time series.

## 9. Fractional Differencing

-   **Description:** Implements fractional differencing.
-   **Functions:** `add_fractional_diff`, `add_fractional_diff_auto`
-   **Parameters:**
    -   `add_fractional_diff`:
        -   `column`: Column to apply fractional differencing to (default: `'close'`).
        -   `d`: Differencing order (default: `0.4`).
        -   `thresh`: Threshold for weight truncation (default: `1e-4`).
    -   `add_fractional_diff_auto`:
        -   `column`: Column to apply fractional differencing to (default: `'close'`).
        -   `d_grid`: Grid to search for optimal d (default: `(0.2, 0.8, 0.1)`).
        -   `pval`: p-value for ADF test (default: `0.05`).
-   **Generated Features:**
    -   `{column}_fracdiff_{d:.2f}`: Fractionally differenced time series.

## 10. Event-Driven Features

-   **Description:** Adds binary and decaying proximity-to-event features.
-   **Function:** `add_event_features`
-   **Parameters:**
    -   `events`: List of timestamps or DataFrame with time (+ optional type).
    -   `event_time_col`: Name of the time column in the events DataFrame (default: `'time'`).
    -   `event_type_col`: Name of the type column in the events DataFrame (default: `'type'`).
    -   `window`: Symmetric window around event time treated as active (default: `'2H'`).
    -   `halflife`: Exponential decay from the event time (default: `'2H'`).
-   **Generated Features:**
    -   `event_active`: Binary indicator for event activity.
    -   `event_decay`: Exponential decay from event time.
    -    `event_{str(typ).lower()}_active`: One-hot encoded features for event types
    -   `ret_post_event_{h}h`: Post event returns
    -   `ret_pre_event_{h}h`: Pre event returns

## 11. Lorentzian Classification

-   **Description:** Adds Lorentzian classification probabilities.
-   **Function:** `add_lorentzian_classification`
-   **Parameters:**
    -   `features`: List of features to use for KDE (default: a list of default features).
    -   `bandwidth`: Bandwidth for KDE (default: `0.1`).
-   **Generated Features:**
    -   `lorentz_buy_prob`: Probability of a buy signal.
    -   `lorentz_sell_prob`: Probability of a sell signal.
    -   `lorentz_hold_prob`: Probability of a hold signal.
